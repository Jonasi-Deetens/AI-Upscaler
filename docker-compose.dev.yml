# Dev overrides: mount source and run dev servers so changes reflect immediately.
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#
# - Frontend: Next.js dev server (Turbopack) with hot reload
# - Backend: uvicorn with --reload
# - Worker: code mounted; restart container to pick up task changes (celery -A app.celery_app worker -B --loglevel=info)

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["sh", "-c", "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"]
    volumes:
      - ./backend:/app
      - storage_data:/app/storage
    environment:
      PYTHONUNBUFFERED: "1"

  worker:
    volumes:
      - ./worker:/app
      - storage_data:/app/storage
    # Restart worker container to pick up Python/task changes, or use: command with watchmedo (optional)

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    environment:
      # Browser (on your machine) calls the backend at this URL. Must be reachable from the host.
      NEXT_PUBLIC_API_URL: http://localhost:8000
      WATCHPACK_POLLING: "true"

volumes:
  frontend_node_modules:
